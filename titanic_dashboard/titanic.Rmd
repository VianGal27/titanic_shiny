---
title: "¿Qué pasajeros sobrevivirán al naufragio del RMS Titanic?"
author: "RG"
date: "14/09/2022"
output:
  html_document:
    df_print: paged
  pdf_document: default
subtitle: Ejercicio Práctico Minería y Análisis de Datos
---

```{r Directorio, echo=F,message=FALSE,warning=FALSE}
#Directorio de Trabajo


#Librerias
library(dplyr)
library(corrplot)
library(ggplot2)
library(stargazer)
library(arm)
library(MASS)

```

## 1) Lectura de los datos.

Para esta práctica utilizaremos el archivo TITANIC.CSV. La base incluye información relevante para describir el estado de supervivencia y datos particulares de los pasajeros del RMS Titanic (no contiene información de la tripulación). La fuente principal de los datos es la Enciclopedia Titanica y contiene las aportaciones de varios investigadores.


```{r AbrirDatos, include=T}
datos <- read.csv("./data/titanic.csv")
datos <- as.data.frame(datos)
#View(datos)
```


Las variables con las que trabajaremos a lo largo de este documento son las siguientes

- *Name*: Nombre del pasajero.

- *Survived*: Dummy que indica si sobrevivió (1) o no sobrevivió (0).

- *Pclass*:Tipo de clase en la que viajó (1=1st; 2=2nd; 3=3rd).

- *Age*: Edad del pasajero.

- *Sex*: Sexo del pasajero.

- *Fare*: Tarifa que pagó el pasajero.

- *Siblings_Spouses*: Indica el número de hermanos y/o cónyuges que lo acompañaron.

- *Parents_Children*:Indica el número de padres y/o hijos que lo acompañaron.

Se crearon ademas dos variables:

- *Fare_grps*: Indicadora de si el pasajero gasto menos de 60 libras o más de 60 libras en el boleto.

- *Family_size*: Numero de integrantes de la familia del pasajero. Se construyó con la suma de de las variables Siblings_Spouses y Parents_Children. Cuando su valor es igual a cero implica que el individuo viajó sin familiares directos.

```{r Variables1, echo=F,message=FALSE,warning=FALSE}

datos <- rename(datos, Siblings_Spouses = Siblings.Spouses.Aboard)
datos <- rename(datos, Parents_Children = Parents.Children.Aboard)
datos <- mutate(datos, Family_size = Siblings_Spouses+Parents_Children)

```


## 2) Relaciones esperadas.


Empezaremos por explorar los valores de las correlaciones de las variables. Para ello elaboraremos un gráfico con la información.


### Matriz de Correlaciones


```{r correlaciones, echo=FALSE,message=FALSE,warning=FALSE,out.width = "70%",fig.align = 'center'}
datos %>% 
  dplyr::select(Survived,Pclass,Age,Fare,Siblings_Spouses, Parents_Children,Family_size) -> Data
M <- round(cor(Data),2)
corrplot::corrplot(M, method="number", type="upper")

```


### Análisis Gráfico


Nos enfocaremos en entender la distribución y las diferentes características de nuestros datos mediante un análisis gráfico de algunas de las variables.


```{r Variables2, echo=F,message=FALSE,warning=FALSE}

datos <- mutate(datos, Pclass = factor(datos$Pclass, order=TRUE, levels = c(3, 2, 1)))
datos <- mutate(datos, Survived = factor(datos$Survived))
datos <- mutate(datos, Age = Age)
datos <- mutate(datos, Fare_grps = case_when(between(Fare, 0, 60) ~ "0-60",  Fare > 60 ~ ">60"))

```


```{r Graf1, echo=FALSE,message=FALSE,warning=FALSE,out.width = "80%",fig.align = 'center'}

ggplot(datos, aes(x = Survived)) +
  geom_bar(width=0.5, alpha=1, fill = "steelblue3") +
  geom_text(stat='count', aes(label=stat(count)), vjust=-0.5)+
  ggtitle("Conteo de sobrevivientes")
```


Podemos observar que de los 887 pasajeros de los cuales tenemos información únicamente 342 de ellos sobrevivieron. Lamentablemente poco más del 60% de los pasajeros falleció. 


```{r Graf2, echo=FALSE,message=FALSE,warning=FALSE,out.width = "60%",fig.align = 'center'}

ggplot(datos, aes(x = Survived, fill=Sex)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat='count', 
            aes(label=stat(count)), 
            position = position_dodge(width=1), vjust=-0.5)+
  ggtitle("Sobrevivientes según el sexo")
```


Para tener una mejor idea de lo que sucedió tras el accidente del Titanic en la gráfica anterior volvemos a concentrarnos en el numero de sobrevivientes, pero considerando el sexo. Como podemos observar, de los 342 pasajeros que sobrevivieron, 233 (alrededor del 68%) fueron mujeres y 109 fueron hombres. En el caso de los pasajeros que no sobrevivieron 464 (cerca del 85% del total) eran hombres.


```{r Graf3, echo=FALSE,message=FALSE,warning=FALSE,out.width = "80%",fig.align = 'center'}

ggplot(datos, aes(x = Survived, fill=Pclass)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat='count', 
            aes(label=stat(count)), 
            position = position_dodge(width=1), 
            vjust=-0.5)+
  ggtitle("Sobrevivientes según la clase en que viajaba")
```


Un punto interesante para analizar es respecto a las diferentes clases en las que los pasajeros se podían alojar. Al separar a los sobrevivientes según el tipo de boleto que tenían podemos observar que, en proporción al total de personas por clase, los de primera fueron el grupo con mayor numero de sobrevivientes, después los de segunda clase y por ultimo los de tercera. Si bien las tres clases tuvieron pasajeros que fallecieron, la tercera clase es la más afectada con alrededor del 67% de fallecidos. 

```{r Graf4, echo=FALSE,message=FALSE,warning=FALSE,out.width = "80%",fig.align = 'center'}

datos$Discretized.age = cut(datos$Age, c(0,10,20,30,40,50,60,70,80,100))
ggplot(datos, aes(x = Discretized.age, fill=Survived)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat='count', aes(label=stat(count)), position = position_dodge(width=1), vjust=-0.5)+
  ggtitle("Sobrevivientes según la edad")
```


Otro aspecto importante del problema es comprender como el suceso afectó a los diferentes grupos de edad. Podemos observar que la mayor cantidad tanto de sobrevivientes como de no sobrevivientes está entre los grupos de 10 a 40 años. 


Para entender mejor los resultados del gráfico anterior presentamos el histograma de las edades de los pasajeros.

```{r Graf5, echo=FALSE,message=FALSE,warning=FALSE,out.width = "70%",fig.align = 'center'}

ggplot(datos, aes(x = Age))+
  geom_histogram(aes(y=..density..),bins=50, color="black", fill="lightblue")+
  geom_density(alpha=.5)+
  ggtitle("Histograma de la edad de los pasajeros")
```



```{r Graf6, echo=FALSE,message=FALSE,warning=FALSE,out.width = "80%",fig.align = 'center'}

ggplot(datos, aes(x = Family_size, fill=Survived)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat='count', 
            aes(label=stat(count)), 
            position = position_dodge(width=1), 
            vjust=-0.5)+
  ggtitle("Sobrevivientes según el número de acompañantes familiares del pasajero")
```

Un punto importante al viajar es saber si se realizó sólo o acompañado. Para analizar este punto consideramos la información de la variable que construimos respecto al tamaño de la familia. Los datos nos muestran que aquellos que viajaban solos (0 en tamaño de la familia) fueron el grupo que concentro el mayor numero de pasajeros que no sobrevivieron.

Nuevamente presentamos el histograma del tamaño de las familias de los pasajeros para enriquecer la interpretación de los resultados del gráfico anterior.


```{r Graf7, echo=FALSE,message=FALSE,warning=FALSE,out.width = "60%",fig.align = 'center'}

ggplot(datos, aes(x = Family_size)) +
  geom_bar(width=0.5, alpha=1, fill = "steelblue3") +
  geom_text(stat='count', aes(label=stat(count)), vjust=-0.5)+
  ggtitle("Histograma del tamaño de la familia")
```


Por último, respecto de las variables con las que contamos es importante comprender el histograma de la tarifa que cubrieron cada uno de los pasajeros. Dado que el tipo de clase en la que se viajaba fue un determinante importante de la probabilidad de no sobrevivir, esto nos ayudará a entender el gasto por boleto que se realizó.

```{r Graf8, echo=FALSE,message=FALSE,warning=FALSE,out.width = "80%",fig.align = 'center'}

ggplot(datos, aes(x = Fare))+
  geom_histogram(aes(y=..density..),bins=50, color="black", fill="lightblue")+
  geom_density(alpha=.5)+
  ggtitle("Histograma de la tarifa pagada por el pasajero")

```

La variable *Fare_grps* se creo pensando en que un boleto que costará mas de 60 libras incorporaría la información de los pasajeros con más recursos. Lo anterior sin importar si se encontraba en primera o segunda clase.


### Algunos Gráficos Adicionales


```{r Graf9, echo=FALSE,message=FALSE,warning=FALSE,out.width = "90%",fig.align = 'center'}

ggplot(datos, aes(x = Survived, fill=Pclass)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat='count', 
            aes(label=stat(count)), 
            position = position_dodge(width=1), 
            vjust=-0.5)+ facet_wrap(~ Sex)+
  ggtitle("Sobrevivientes según la clase en que viajaba y el sexo")
```



```{r Graf10, echo=FALSE,message=FALSE,warning=FALSE,out.width = "90%",fig.align = 'center'}

datos$Discretized.age = cut(datos$Age, c(0,10,20,30,40,50,60,70,80,100))
ggplot(datos, aes(x = Discretized.age, fill=Survived)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat='count', aes(label=stat(count)), position = position_dodge(width=1), vjust=-0.5)+  facet_wrap(~ Sex)+
  ggtitle("Sobrevivientes según la edad y el sexo")
```


```{r Graf11, echo=FALSE,message=FALSE,warning=FALSE,out.width = "90%",fig.align = 'center'}

ggplot(datos, aes(x = Family_size, fill=Survived)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat='count', 
            aes(label=stat(count)), 
            position = position_dodge(width=1), 
            vjust=-0.5)+ facet_wrap(~ Sex)+
  ggtitle("Sobrevivietes según el sexo y el tamaño de la familia")

```


```{r Graf12, echo=FALSE,message=FALSE,warning=FALSE,out.width = "90%",fig.align = 'center'}

ggplot(datos, aes(x = Family_size, fill=Survived)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat='count', 
            aes(label=stat(count)), 
            position = position_dodge(width=1), 
            vjust=-0.5)+ facet_wrap(~ Pclass)+
  ggtitle("Sobrevivientes según la clase y tamaño de la familia")

```


```{r Graf13, echo=FALSE,message=FALSE,warning=FALSE,out.width = "90%",fig.align = 'center'}

ggplot(datos, aes(x = Fare_grps, fill=Survived)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat='count', 
            aes(label=stat(count)), 
            position = position_dodge(width=1), 
            vjust=-0.5)+ facet_wrap(~ Pclass)+
  ggtitle("Sobrevivientes según la clase y el gasto en el boleto")

```


```{r Graf14, echo=FALSE,message=FALSE,warning=FALSE,out.width = "100%",fig.align = 'center'}

ggplot(datos, aes(x = Fare_grps, fill=Survived)) +
  geom_bar(position = position_dodge()) +
  geom_text(stat='count', 
            aes(label=stat(count)), 
            position = position_dodge(width=1), 
            vjust=-0.5)+ facet_wrap(~ Sex)+
  ggtitle("Supervivencia según el sexo y el gasto en el boleto")

```


```{r Variables3, echo=F,message=FALSE,warning=FALSE}

datos$Discretized.age = NULL
datos$Name = NULL

```




## 3) Estimación del modelo.

```{r VariablesR, echo=F,message=FALSE,warning=FALSE}
datos <- read.csv("./data/titanic.csv")
datos <- as.data.frame(datos)
datos <- rename(datos, Siblings_Spouses = Siblings.Spouses.Aboard)
datos <- rename(datos, Parents_Children = Parents.Children.Aboard)
datos <- mutate(datos, Family_size = Siblings_Spouses+Parents_Children)
datos <- mutate(datos, Fare_grps = case_when(between(Fare, 0, 60) ~ "0-60",  Fare > 60 ~ ">60"))
datos$Class_1 = ifelse(datos$Pclass == 1,1,0)
datos$Class_2 = ifelse(datos$Pclass == 2,1,0)
datos$Class_3 = ifelse(datos$Pclass == 3,1,0)

```


### Probabilidad de Sobrevivir - Modelo Logit


En primer lugar nos interesa entender que determinó la probabilidad de sobrevivir. Para estimar un modelo que nos ayude a comprender este dilema utilizaremos varios modelos Logit. La diferencia entre cada una de las especificaciones será el tipo de variables que agreguemos.


De las variables que analizamos en la sección anterior elegimos como base incorporar *Pclass, Sex, Age*. Los diferentes modelos que especificamos para el logit tendrán como diferencia como tratamos las variables *Fare, Siblings_Spouses, Parents_Children*.

En cuanto a la variable *Fare*, algunos modelos la consideraran tal como está reportada en la base de datos y en otros utilizaremos *Fare_grps*. Esta última variable se incorpora pensando que el gasto en el boleto pudo tener ciertos rangos al considerar las características de cada pasajero. La intención es ver cual variable resulta mejor.


Respecto las variables Siblings_Spouses, Parents_Children y Family_size, en algunas especificaciones buscaremos ver si el modelo responde mejor al numero total de integrantes de la familia en comparación contra la separación que tenia la base con las variables Siblings_Spouses y Parents_Children. 


```{r Regresion1, echo=FALSE,message=FALSE,warning=FALSE, results="asis"}
logit1 <- glm(Survived ~ Pclass + Sex + Age + Fare + Siblings_Spouses + Parents_Children, data = datos, family=binomial(link="logit"))
logit.or1 = exp(coef(logit1))

logit2 <- glm(Survived ~ Pclass  + Sex + Age + Fare_grps + Siblings_Spouses + Parents_Children, data = datos, family=binomial(link="logit"))
logit.or2 = exp(coef(logit2))

logit3 <- glm(Survived ~ Pclass  + Sex + Age + Fare + Family_size, data = datos, family=binomial(link="logit"))
logit.or3 = exp(coef(logit3))

logit4 <- glm(Survived ~ Pclass  + Sex + Age + Fare_grps + Family_size, data = datos, family=binomial(link="logit"))
logit.or4 = exp(coef(logit4))

```



```{r reg1, echo=FALSE,message=FALSE,warning=FALSE, results="asis"}

stargazer(logit1,logit2,logit3,logit4,
          title= "Logit con coeficientes exponenciados",
          digits = 4, font.size="small",
          coef=list(logit.or1,logit.or2,logit.or3,logit.or4),
          p.auto=FALSE,
          no.space = TRUE, single.row = FALSE,
          table.placement= "H", float= FALSE,
          type='latex',header=FALSE)
```


- El modelo 1 y 3 utilizan a la variable Fare y permiten ver como cambia el resultado de la especificación al usar el numero total de miembros de la familia vs sus componentes separados. Los modelos 2 y 4 miden la incorporación de Fare_grps y nos permiten comparar las diferencias de la familia.


- Las variables Sex, Age y Pclass en todos los modelos conservan su significancia y tienen cambios mínimos en el valor de sus coeficientes. Podemos interpretar de ellas que cambiar de clase (pasar de 1era a 2nda o de 1era a 3era) reduce en un 70% la probabilidad de sobrevivir. En el caso de Sex observamos que ser hombre, está relacionado a una disminución del 93% en la probabilidad de sobrevivir. Para Age, un aumento en los años del pasajero reduce en 4.25% la probabilidad de sobrevivir.


- Las variables relativas a la tarifa que pagaron los pasajeros resultan ser no significativas. Podemos concluir que no es relevante para cambiar la probabilidad de supervivencia ese gasto ni su análisis por grupos.
 

- Respecto a los acompañantes del pasajero. En los modelos 1 y 3 pareciera que sólo es importante la información de si viajó con hermanos y/o esposa y no tanto si lo hizo con hijos o sus padres. Sin embargo con los modelo 2 y 4, podemos ver que el tamaño completo de la Familia es importante. En resumen, tener uno o más familiares abordo reduce la probabilidad de sobrevivir en alrededor del 21%.


*Separando entre clases*


```{r Regresio12, echo=FALSE,message=FALSE,warning=FALSE, results="asis"}
logit1 <- glm(Survived ~ Class_2 + Class_3 + Sex + Age + Fare + Siblings_Spouses + Parents_Children, data = datos, family=binomial(link="logit"))
logit.or1 = exp(coef(logit1))

logit2 <- glm(Survived ~ Class_2 + Class_3  + Sex + Age + Fare_grps + Siblings_Spouses + Parents_Children, data = datos, family=binomial(link="logit"))
logit.or2 = exp(coef(logit2))

logit3 <- glm(Survived ~ Class_2 + Class_3  + Sex + Age + Fare + Family_size, data = datos, family=binomial(link="logit"))
logit.or3 = exp(coef(logit3))

logit4 <- glm(Survived ~ Class_2 + Class_3  + Sex + Age + Fare_grps + Family_size, data = datos, family=binomial(link="logit"))
logit.or4 = exp(coef(logit4))

```


```{r reg12, echo=FALSE,message=FALSE,warning=FALSE, results="asis"}

stargazer(logit1,logit2,logit3,logit4,
          title= "Logit con coeficientes exponenciados",
          digits = 4, font.size="small",
          coef=list(logit.or1,logit.or2,logit.or3,logit.or4),
          p.auto=FALSE,
          no.space = TRUE, single.row = FALSE,
          table.placement= "H", float= FALSE,
          type='latex',header=FALSE)
```


-Esta especificación nos permite comparar los cambios en clase. Podemos observar dos cosas importantes. Para un pasajero en segunda clase su probabilidad de no sobrevivir aumenta en alrededor de un 70% respecto de uno de primera clase. La segunda, un pasajero de tercera clase tiene un 90% más de probabilidad de no sobrevivir en comparación con un pasajero de primera clase.


### Diferencias entre clases de viaje - Modelo Logit Ordenado

Un segundo análisis que elaboraremos será entorno a la clase en la que los pasajeros viajaban. Para esta sección utilizaremos un logit ordenado para poder entender las diferencias entre clases. Al igual que en el punto anterior la diferencia entre cada una de las especificaciones será el tipo de variables que agreguemos.


```{r Regresion2, echo=FALSE,message=FALSE,warning=FALSE, results="asis"}

datos <- mutate(datos, Pclass = factor(datos$Pclass, order=TRUE, levels = c(3, 2, 1)))

m1 <- polr(Pclass ~ Sex + Age + Fare + Siblings_Spouses + Parents_Children, data=datos, Hess=TRUE)
m1.coef <- data.frame(coef(summary(m1)))
m1.coef$pval = round((pnorm(abs(m1.coef$t.value), lower.tail = FALSE) * 2),2)
m1.or=exp(coef(m1))

m2 <- polr(Pclass ~ Sex + Age + Fare_grps + Siblings_Spouses + Parents_Children, data=datos, Hess=TRUE)
m2.coef <- data.frame(coef(summary(m1)))
m2.coef$pval = round((pnorm(abs(m2.coef$t.value), lower.tail = FALSE) * 2),2)
m2.or=exp(coef(m2))

m3 <- polr(Pclass ~ Sex + Age + Fare + Family_size, data=datos, Hess=TRUE)
m3.coef <- data.frame(coef(summary(m3)))
m3.coef$pval = round((pnorm(abs(m3.coef$t.value), lower.tail = FALSE) * 2),2)
m3.or=exp(coef(m3))

m4 <- polr(Pclass ~ Sex + Age + Fare_grps + Family_size, data=datos, Hess=TRUE)
m4.coef <- data.frame(coef(summary(m4)))
m4.coef$pval = round((pnorm(abs(m4.coef$t.value), lower.tail = FALSE) * 2),2)
m4.or=exp(coef(m4))

stargazer(m1,m2,m3,m4,
          title= "Logit con coeficientes exponenciados",
          digits = 4, font.size='scriptsize',
          coef=list(m1.or,m2.or,m3.or,m4.or),
          p.auto=FALSE,
          no.space = TRUE, single.row = FALSE,
          table.placement= "H", float= FALSE,
          type='latex',header=FALSE)
```


- Las especificaciones anteriores siguen la misma lógica que los del apartado anterior. Todos consideran Age, Sex y buscamos comparar las diferentes variables para la tarifa (Fare vs Fare_grps) y para la forma de considerar a los acompañantes.

-Podemos concluir dos cosas. La primera, la diferencia del modelo para estimar si sobrevive o no, la variable que incorpore la información de la tarifa pagada es importante (más allá de si es en valor directo o por grupo)pero resulta mejor la interpretación y el uso de Fare. La segunda, nuevamente es una mejor opción el considerar a todos los acompañantes (familiares) que acompañaron al pasajero.

-Respecto de los resultados. Ser hombre disminuye en alrededor de un 35% la probabilidad de cambiar de clase. Un aumento en la edad del pasajero aumenta en alrededor de un 4.5% la probabilidad de cambiar de clase. Un cambio en la tarifa que debe cubrir el pasajero aumenta en un 17% la probabilidad de cambiar de clase (de primera a segunda o de segunda a tercera). Este ultimo punto se puede entender en que se vuelve más caro el boleto y por eso buscas una clase más baja pero asequible. Por último, el viajar con uno o más familiares disminuye la probabilidad de cambiar de clase.


## 4) Apéndice Tablas


Modelos logit sin transformar los valores de los coeficientes.


### *Probabilidad de sobrevivir*


```{r reg3, echo=FALSE,message=FALSE,warning=FALSE, results="asis"}
stargazer(logit1,logit2,logit3,logit4,
          title= "Logit sin exponenciar coeficientes",
          digits = 4, font.size="scriptsize",
          no.space = TRUE, single.row = FALSE,
          table.placement= "H", float= FALSE,
          type='latex',header=FALSE)
```


### *Tipo de Clase*


```{r Reg4,echo=FALSE,message=FALSE,warning=FALSE, results="asis"}
stargazer(m1,m2,m3,m4,
          title= "Logit sin exponenciar coeficientes",
          digits = 4, font.size="scriptsize",
          no.space = TRUE, single.row = FALSE,
          table.placement= "H", float= FALSE,
          type='latex',header=FALSE)
```



